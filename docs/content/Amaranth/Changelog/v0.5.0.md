# Version 0.5.0

The Migen compatibility layer has been removed.

## Migrating from version 0.4

Apply the following changes to code written against Amaranth 0.4 to migrate it to version 0.5:

- Update uses of {py}`reset=` keyword argument to {py}`init=`.
- Ensure all elaboratables are subclasses of {class}`Elaboratable`.
- Replace uses of {py}`m.Case()` with no patterns with {py}`m.Default()`.
- Replace uses of {py}`Value.matches()` with no patterns with {py}`Const(1)`.
- Ensure clock domains aren't used outside the module that defines them, or its submodules; move clock domain definitions upwards in the hierarchy as necessary
- Replace imports of {py}`amaranth.asserts.Assert`, {py}`Assume`, and {py}`Cover` with imports from {py}`amaranth.hdl`.
- Remove uses of {py}`name=` keyword argument of {py}`Assert`, {py}`Assume`, and {py}`Cover`; a message can be used instead.
- Replace uses of {py}`amaranth.hdl.Memory` with {class}`amaranth.lib.memory.Memory`.
- Update uses of {py}`platform.request` to pass {py}`dir="-"` and use {mod}`amaranth.lib.io` buffers.
- Remove uses of {py}`amaranth.lib.coding.*` by inlining or copying the implementation of the modules.
- Convert uses of {py}`Simulator.add_sync_process` used as testbenches to {meth}`Simulator.add_testbench <amaranth.sim.Simulator.add_testbench>`.
- Convert other uses of {py}`Simulator.add_sync_process` to {meth}`Simulator.add_process <amaranth.sim.Simulator.add_process>`.
- Convert simulator processes and testbenches to use the new async API.
- Update uses of {meth}`Simulator.add_clock <amaranth.sim.Simulator.add_clock>` with explicit {py}`phase` to take into account simulator no longer adding implicit {py}`period / 2`. (Previously, {meth}`Simulator.add_clock <amaranth.sim.Simulator.add_clock>` was documented to first toggle the clock at the time {py}`phase`, but actually first toggled the clock at {py}`period / 2 + phase`.)
- Update uses of {meth}`Simulator.run_until <amaranth.sim.Simulator.run_until>` to remove the {py}`run_passive=True` argument. If the code uses {py}`run_passive=False`, ensure it still works with the new behavior.
- Update uses of {py}`amaranth.utils.log2_int(need_pow2=False)` to {func}`amaranth.utils.ceil_log2`.
- Update uses of {py}`amaranth.utils.log2_int(need_pow2=True)` to {func}`amaranth.utils.exact_log2`.
- Replace uses of {py}`a.implies(b)` with `~a | b`.

## Implemented RFCs

- [RFC 17]: Remove `log2_int`
- [RFC 27]: Testbench processes for the simulator
- [RFC 30]: Component metadata
- [RFC 36]: Async testbench functions
- [RFC 39]: Change semantics of no-argument `m.Case()`
- [RFC 42]: `Const` from shape-castable
- [RFC 43]: Rename `reset=` to `init=`
- [RFC 45]: Move `hdl.Memory` to `lib.Memory`
- [RFC 46]: Change `Shape.cast(range(1))` to `unsigned(0)`
- [RFC 50]: `Print` statement and string formatting
- [RFC 51]: Add `ShapeCastable.from_bits` and `amaranth.lib.data.Const`
- [RFC 53]: Low-level I/O primitives
- [RFC 55]: New `lib.io` components
- [RFC 58]: Core support for `ValueCastable` formatting
- [RFC 59]: Get rid of upwards propagation of clock domains
- [RFC 61]: Minimal streams
- [RFC 62]: The `MemoryData` class
- [RFC 63]: Remove `amaranth.lib.coding`
- [RFC 65]: Special formatting for structures and enums

## Language changes

```{eval-rst}
.. currentmodule:: amaranth.hdl
```

- Added: {class}`Slice` objects have been made const-castable.
- Added: {func}`amaranth.utils.ceil_log2`, {func}`amaranth.utils.exact_log2`. ([RFC 17])
- Added: {class}`Format` objects, {class}`Print` statements, messages in {class}`Assert`, {class}`Assume` and {class}`Cover`. ([RFC 50])
- Added: {meth}`ShapeCastable.from_bits` method. ([RFC 51])
- Added: IO values, {class}`IOPort` objects, {class}`IOBufferInstance` objects. ([RFC 53])
- Added: {class}`MemoryData` objects. ([RFC 62])
- Changed: {py}`m.Case()` with no patterns is never active instead of always active. ([RFC 39])
- Changed: {py}`Value.matches()` with no patterns is {py}`Const(0)` instead of {py}`Const(1)`. ([RFC 39])
- Changed: {py}`Signal(range(stop), init=stop)` warning has been changed into a hard error and made to trigger on any out-of range value.
- Changed: {py}`Signal(range(0))` is now valid without a warning.
- Changed: {py}`Const(value, shape)` now accepts shape-castable objects as {py}`shape`. ([RFC 42])
- Changed: {py}`Shape.cast(range(1))` is now {py}`unsigned(0)`. ([RFC 46])
- Changed: the {py}`reset=` argument of {class}`Signal`, {meth}`Signal.like`, {class}`amaranth.lib.wiring.Member`, {class}`amaranth.lib.cdc.FFSynchronizer`, and {py}`m.FSM()` has been renamed to {py}`init=`. ([RFC 43])
- Changed: {class}`Shape` has been made immutable and hashable.
- Changed: {class}`Assert`, {class}`Assume`, {class}`Cover` have been moved to {mod}`amaranth.hdl` from {mod}`amaranth.asserts`. ([RFC 50])
- Changed: {class}`Instance` IO ports now accept only IO values, not plain values. ([RFC 53])
- Deprecated: {func}`amaranth.utils.log2_int`. ([RFC 17])
- Deprecated: {class}`amaranth.hdl.Memory`. ([RFC 45])
- Deprecated: upwards propagation of clock domains. ([RFC 59])
- Deprecated: {meth}`Value.implies`.
- Removed: (deprecated in 0.4.0) {meth}`Const.normalize`. ([RFC 5])
- Removed: (deprecated in 0.4.0) {class}`Repl`. ([RFC 10])
- Removed: (deprecated in 0.4.0) {class}`ast.Sample`, {class}`ast.Past`, {class}`ast.Stable`, {class}`ast.Rose`, {class}`ast.Fell`.
- Removed: assertion names in {class}`Assert`, {class}`Assume` and {class}`Cover`. ([RFC 50])
- Removed: accepting non-subclasses of {class}`Elaboratable` as elaboratables.

## Standard library changes

```{eval-rst}
.. currentmodule:: amaranth.lib
```

- Added: {mod}`amaranth.lib.memory`. ([RFC 45])
- Added: {class}`amaranth.lib.data.Const` class. ([RFC 51])
- Changed: {meth}`amaranth.lib.data.Layout.const` returns a {class}`amaranth.lib.data.Const`, not a view ([RFC 51])
- Changed: {meth}`amaranth.lib.wiring.Signature.is_compliant` no longer rejects reset-less signals.
- Added: {class}`amaranth.lib.io.SingleEndedPort`, {class}`amaranth.lib.io.DifferentialPort`. ([RFC 55])
- Added: {class}`amaranth.lib.io.Buffer`, {class}`amaranth.lib.io.FFBuffer`, {class}`amaranth.lib.io.DDRBuffer`. ([RFC 55])
- Added: {mod}`amaranth.lib.meta`, {class}`amaranth.lib.wiring.ComponentMetadata`. ([RFC 30])
- Added: {mod}`amaranth.lib.stream`. ([RFC 61])
- Deprecated: {mod}`amaranth.lib.coding`. ([RFC 63])
- Removed: (deprecated in 0.4.0) {mod}`amaranth.lib.scheduler`. ([RFC 19])
- Removed: (deprecated in 0.4.0) {class}`amaranth.lib.fifo.FIFOInterface` with {py}`fwft=False`. ([RFC 20])
- Removed: (deprecated in 0.4.0) {class}`amaranth.lib.fifo.SyncFIFO` with {py}`fwft=False`. ([RFC 20])

## Toolchain changes

- Added: {meth}`Simulator.add_testbench <amaranth.sim.Simulator.add_testbench>`. ([RFC 27])
- Added: async function support in {meth}`Simulator.add_testbench <amaranth.sim.Simulator.add_testbench>` and {meth}`Simulator.add_process <amaranth.sim.Simulator.add_process>`. ([RFC 36])
- Added: support for {class}`amaranth.hdl.Assert` in simulation. ([RFC 50])
- Changed: {meth}`Simulator.add_clock <amaranth.sim.Simulator.add_clock>` no longer implicitly adds {py}`period / 2` when {py}`phase` is specified, actually matching the documentation.
- Changed: {meth}`Simulator.run_until <amaranth.sim.Simulator.run_until>` always runs the simulation until the given deadline, even when no critical processes or testbenches are present.
- Deprecated: {py}`Settle` simulation command. ([RFC 27])
- Deprecated: {py}`Simulator.add_sync_process`. ([RFC 27])
- Deprecated: generator-based simulation processes and testbenches. ([RFC 36])
- Deprecated: the {py}`run_passive` argument to {meth}`Simulator.run_until <amaranth.sim.Simulator.run_until>` has been deprecated, and does nothing.
- Removed: (deprecated in 0.4.0) use of mixed-case toolchain environment variable names, such as `NMIGEN_ENV_Diamond` or `AMARANTH_ENV_Diamond`; use upper-case environment variable names, such as `AMARANTH_ENV_DIAMOND`.

## Platform integration changes

```{eval-rst}
.. currentmodule:: amaranth.vendor
```

- Added: {meth}`BuildPlan.execute_local_docker`.
- Added: {meth}`BuildPlan.extract`.
- Added: `build.sh`  begins with `#!/bin/sh`.
- Changed: `IntelPlatform` renamed to `AlteraPlatform`.
- Deprecated: argument {py}`run_script=` in {meth}`BuildPlan.execute_local`.
- Removed: (deprecated in 0.4.0) {mod}`vendor.intel`, {mod}`vendor.lattice_ecp5`, {mod}`vendor.lattice_ice40`, {mod}`vendor.lattice_machxo2_3l`, {mod}`vendor.quicklogic`, {mod}`vendor.xilinx`. ([RFC 18])
