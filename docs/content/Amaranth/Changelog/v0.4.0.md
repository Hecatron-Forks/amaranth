# Version 0.4.0

Support has been added for a new and improved way of defining data structures in {mod}`amaranth.lib.data` and component interfaces in {mod}`amaranth.lib.wiring`, as defined in [RFC 1] and [RFC 2]. {class}`Record` has been deprecated. In a departure from the usual policy, to give designers additional time to migrate, {class}`Record` will be removed in Amaranth 0.6 (one release later than normal).

Support for enumerations has been extended. A shape for enumeration members can be provided for an enumeration class, as defined in [RFC 3].

The language includes several new extension points for integration with {class}`Value` based data structures defined outside of the core language. In particular, `Signal(shape)` may now return a {class}`Signal` object wrapped in another if `shape` implements the call protocol, as defined in [RFC 15].

Several issues with shape inference have been resolved. Notably, `a - b` where both `a` and `b` are unsigned now returns a signed value.

Support for Python 3.6 and 3.7 has been removed, and support for Python 3.11 and 3.12 has been added.

Features deprecated in version 0.3 have been removed. In particular, the `nmigen.*` namespace is not provided, `# nmigen:` annotations are not recognized, and `NMIGEN_*` envronment variables are not used.

The Migen compatibility layer remains deprecated (as it had been since Amaranth 0.1), and is now scheduled to be removed in version 0.5.

## Migrating from version 0.3

Apply the following changes to code written against Amaranth 0.3 to migrate it to version 0.4:

- Update shell environment to use `AMARANTH_*` environment variables instead of `NMIGEN_*` environment variables.
- Update shell environment to use `AMARANTH_ENV_<TOOLCHAIN>` (with all-uppercase `<TOOLCHAIN>` name) environment variable names instead of `AMARANTH_ENV_<Toolchain>` or `NMIGEN_ENV_<Toolchain>` (with mixed-case `<Toolchain>` name).
- Update imports of the form `from amaranth.vendor.some_vendor import SomeVendorPlatform` to `from amaranth.vendor import SomeVendorPlatform`. This change will reduce future churn.
- Replace uses of `Const.normalize(value, shape)` with `Const(value, shape).value`.
- Replace uses of `Repl(value, count)` with `value.replicate(count)`.
- Replace uses of `Record` with {mod}`amaranth.lib.data` and {mod}`amaranth.lib.wiring`. The appropriate replacement depends on the use case. If `Record` was being used for data storage and accessing the bit-level representation, use {mod}`amaranth.lib.data`. If `Record` was being used for connecting design components together, use {mod}`amaranth.lib.wiring`.
- Replace uses of `Sample`, `Past`, `Stable`, `Rose`, `Fell` with a manually instantiated register, e.g. `past_x = Signal.like(x); m.d.sync += past_x.eq(x)`.
- Remove uses of `amaranth.compat` by migrating to native Amaranth syntax.
- Ensure the `Pin` instance returned by `platform.request` is not cast to value directly, but used for its fields. Replace code like `leds = Cat(platform.request(led, n) for n in range(4))` with `leds = Cat(platform.request(led, n).o for n in range(4))` (note the `.o`).
- Remove uses of `amaranth.lib.scheduler.RoundRobin` by inlining or copying the implementation of that class.
- Remove uses of `amaranth.lib.fifo.SyncFIFO(fwft=False)` and `amaranth.lib.fifo.FIFOInterface(fwft=False)` by converting code to use `fwft=True` FIFOs or copying the implementation of those classes.

While code that uses the features listed as deprecated below will work in Amaranth 0.4, they will be removed in the next version.

## Implemented RFCs

- [RFC 1]: Aggregate data structure library
- [RFC 2]: Interface definition library
- [RFC 3]: Enumeration shapes
- [RFC 4]: Constant-castable expressions
- [RFC 5]: Remove `Const.normalize`
- [RFC 6]: CRC generator
- [RFC 8]: Aggregate extensibility
- [RFC 9]: Constant initialization for shape-castable objects
- [RFC 10]: Move `Repl` to `Value.replicate`
- [RFC 18]: Reorganize vendor platforms
- [RFC 19]: Remove `amaranth.lib.scheduler`
- [RFC 15]: Lifting shape-castable objects
- [RFC 20]: Deprecate non-FWFT FIFOs
- [RFC 22]: Define `ValueCastable.shape()`
- [RFC 28]: Allow overriding `Value` operators
- [RFC 31]: Enumeration type safety
- [RFC 34]: Rename `amaranth.lib.wiring.Interface` to `PureInterface`
- [RFC 35]: Add `ShapeLike`, `ValueLike`
- [RFC 37]: Make `Signature` immutable
- [RFC 38]: `Component.signature` immutability

## Language changes

```{eval-rst}
.. currentmodule:: amaranth.hdl
```

- Added: {class}`ShapeCastable`, similar to {class}`ValueCastable`.
- Added: {class}`ShapeLike` and {class}`ValueLike`. ([RFC 35])
- Added: {meth}`Value.as_signed` and {meth}`Value.as_unsigned` can be used on left-hand side of assignment (with no difference in behavior).
- Added: {meth}`Const.cast`. ([RFC 4])
- Added: `Signal(reset=)`, {meth}`Value.matches`, `with m.Case():` accept any constant-castable objects. ([RFC 4])
- Added: {meth}`Value.replicate`, superseding {class}`Repl`. ([RFC 10])
- Added: {class}`Memory` supports transparent read ports with read enable.
- Changed: creating a {class}`Signal` with a shape that is a {class}`ShapeCastable` implementing {meth}`ShapeCastable.__call__` wraps the returned object using that method. ([RFC 15])
- Changed: {meth}`Value.cast` casts {class}`ValueCastable` objects recursively.
- Changed: {meth}`Value.cast` treats instances of classes derived from both {class}`enum.Enum` and {class}`int` (including {class}`enum.IntEnum`) as enumerations rather than integers.
- Changed: {meth}`Value.matches` with an empty list of patterns returns `Const(1)` rather than `Const(0)`, to match the behavior of `with m.Case():`.
- Changed: {func}`Cat` warns if an enumeration without an explicitly specified shape is used. ([RFC 3])
- Changed: `signed(0)` is no longer constructible. (The semantics of this shape were never defined.)
- Changed: {meth}`Value.__abs__` returns an unsigned value.
- Deprecated: {class}`ast.Sample`, {class}`ast.Past`, {class}`ast.Stable`, {class}`ast.Rose`, {class}`ast.Fell`. (Predating the RFC process.)
- Deprecated: {meth}`Const.normalize`; use `Const(value, shape).value` instead of `Const.normalize(value, shape)`. ([RFC 5])
- Deprecated: {class}`Repl`; use {meth}`Value.replicate` instead. ([RFC 10])
- Deprecated: {class}`Record`; use {mod}`amaranth.lib.data` and {mod}`amaranth.lib.wiring` instead. ([RFC 1], [RFC 2])
- Removed: (deprecated in 0.1) casting of {class}`Shape` to and from a `(width, signed)` tuple.
- Removed: (deprecated in 0.3) {class}`ast.UserValue`.
- Removed: (deprecated in 0.3) support for `# nmigen:` linter instructions at the beginning of file.

## Standard library changes

```{eval-rst}
.. currentmodule:: amaranth.lib
```

- Added: {mod}`amaranth.lib.enum`. ([RFC 3])
- Added: {mod}`amaranth.lib.data`. ([RFC 1])
- Added: {mod}`amaranth.lib.wiring`. ([RFC 2])
- Added: {mod}`amaranth.lib.crc`. ([RFC 6])
- Deprecated: {mod}`amaranth.lib.scheduler`. ([RFC 19])
- Deprecated: {class}`amaranth.lib.fifo.FIFOInterface` with `fwft=False`. ([RFC 20])
- Deprecated: {class}`amaranth.lib.fifo.SyncFIFO` with `fwft=False`. ([RFC 20])

## Toolchain changes

```{eval-rst}
.. currentmodule:: amaranth
```

- Changed: text files are written with LF line endings on Windows, like on other platforms.
- Added: `debug_verilog` override in {class}`build.TemplatedPlatform`.
- Added: `env=` argument to {meth}`build.run.BuildPlan.execute_local`.
- Changed: {meth}`build.run.BuildPlan.add_file` rejects absolute paths.
- Deprecated: use of mixed-case toolchain environment variable names, such as `NMIGEN_ENV_Diamond` or `AMARANTH_ENV_Diamond`; use upper-case environment variable names, such as `AMARANTH_ENV_DIAMOND`.
- Removed: (deprecated in 0.3) {meth}`sim.Simulator.step`.
- Removed: (deprecated in 0.3) {mod}`back.pysim`.
- Removed: (deprecated in 0.3) support for invoking {func}`back.rtlil.convert()` and {func}`back.verilog.convert()` without an explicit `ports=` argument.
- Removed: (deprecated in 0.3) {mod}`test`.

## Platform integration changes

```{eval-rst}
.. currentmodule:: amaranth.vendor
```

- Added: `icepack_opts` override in {class}`vendor.LatticeICE40Platform`.
- Added: `OSCH` as `default_clk` clock source in {class}`vendor.LatticeMachXO2Platform`, {class}`vendor.LatticeMachXO3LPlatform`.
- Added: Xray toolchain support in {class}`vendor.XilinxPlatform`.
- Added: Artix UltraScale+ part support in {class}`vendor.XilinxPlatform`.
- Added: {class}`vendor.GowinPlatform`.
- Deprecated: {mod}`vendor.intel`, {mod}`vendor.lattice_ecp5`, {mod}`vendor.lattice_ice40`, {mod}`vendor.lattice_machxo2_3l`, {mod}`vendor.quicklogic`, {mod}`vendor.xilinx`; import platforms directly from {mod}`vendor` instead. ([RFC 18])
- Removed: (deprecated in 0.3) {mod}`lattice_machxo2`
- Removed: (deprecated in 0.3) {class}`lattice_machxo_2_3l.LatticeMachXO2Or3LPlatform` SVF programming vector `{{name}}.svf`.
- Removed: (deprecated in 0.3) {class}`xilinx_spartan_3_6.XilinxSpartan3APlatform`, {class}`xilinx_spartan_3_6.XilinxSpartan6Platform`, {class}`xilinx_7series.Xilinx7SeriesPlatform`, {class}`xilinx_ultrascale.XilinxUltrascalePlatform`.
